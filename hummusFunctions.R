# Dependencies
library(rentrez)
library(stringr)
library(dplyr)
library(curl)
library(httr)


getArchids <- function(gene_family) {
  
  # gene_family, a vector with conserved domains defining a given gene family 
  cd <- vector(mode = "character")
  
  for(i in seq_along(gene_family)) {
    cd <- c(cd, getSparcleArchs(gene_family[i]))
  }
  
  unique(cd)
}


getSparcleArchs <- function(CD){
  
  # CD, string with the conserved domain
  id = entrez_search(db = "cdd", term = paste0(CD,"[ALL]"))
  cd = entrez_summary(db = "cdd", id = id$ids)
  sparcle = entrez_link(dbfrom = "cdd", db = "sparcle", id = cd$uid)
  sparcle$links$cdd_sparcle
  
  }



getSparcleIds <- function(my_ids, filter) {
  ## CD, string with the conserved domain (used as filter)
  ## sanitty check: some sparcle ids do not give esummary. ex: "12217856"
  
  my_labelsIds <- vector(mode = "character")
  
  for(id in my_ids) {
    sid = entrez_summary(db = "sparcle", id = id)
    
    # only if there is esummary: 
    if(length(sid) > 2) {
      
      # check label contains required CDs
      if(sum(str_count(sid$displabel, filter)) == length(filter) ) {
        #print(paste(id, sid$displabel))
        my_labelsIds <- c(my_labelsIds, id)
      }
      
      
    }
    
  }
  my_labelsIds
}



getSparcleLabels <- function(labelsIds) {
  
  for(label in labelsIds) {
    my_label_sum = entrez_summary(db = "sparcle", id = label)
    print(paste(label, my_label_sum$displabel))
    
  }
  
}



getProtlinks <- function(sparcleArch) {
  spar_to_prot = entrez_link(dbfrom = "sparcle", db = "protein", id = sparcleArch)
  prot_links = spar_to_prot$links$sparcle_protein
  prot_links
}


extract_proteins <- function(targets, taxonIds) {
  
  # Initializes vector with the solution
  vals = c()
  
  ## A. Get taxids with protein ids in RefSeq
  #1 For each id : esummary
  prot_summ = entrez_summary(db = "protein", id = targets)
  
  #2 Extract from esummary: 'sourcedb' and 'taxid'
  prot_db = extract_from_esummary(prot_summ, c("sourcedb", "taxid"))
  
  #3 Build df 
  prot_db = data.frame(matrix(unlist(prot_db), nrow = length(prot_db)/2, byrow = T), 
                       row.names = colnames(prot_db), stringsAsFactors = F) #/2 bc 2 columns: sourcedb-taxid
  
  #4 New df: Filter by RefSeq db. Section C extract ids from this table
  #df2_refseq = prot_db %>% filter(X1 == "refseq")
  df2_refseq <- prot_db[prot_db$X1 == "refseq",]
  
  #5 Pull taxids
  taxids_refseq = unique(as.numeric(df2_refseq %>% pull()))
  
  ## B. Get taxids only from Legume family 
  # If Legume: 
  if(sum(taxids_refseq %in% taxonIds) != 0) {
    idx = which(taxids_refseq %in% taxonIds) 
    taxids_refseq[idx] # Legume taxid with refseq protein
    

    # C. If Legume, extract fromm df some stuff
    ## df2_refseq %>% filter(X2 %in% taxids_refseq[idx])
    ## base R
    vals = c(vals, rownames(df2_refseq[df2_refseq$X2 %in% taxids_refseq[idx],]))
    
  }
  
  vals
  
}



subsetIds <- function(x, sizeIds) {
  #''' x, a vector of one or more elements
  #sizeIds, a positive number, the number of items to choose from '''
  
  # initializes an empty list
  vals = list()
  
  foo = sample(x, size = sizeIds, replace = FALSE)        # 1st sample
  vals[[1]] = foo                                         # add 1st element to the list
  
  #update vector x
  x = x[! x %in% foo]
  
  i = 2
  
  while(length(x) >= sizeIds) {
    
    foo = sample(x, size = sizeIds, replace = FALSE)     # n sample
    vals[[i]] = foo                                      # add n-th element to the list
    
    #update vector x
    x = x[! x %in% foo]
    
    i = i+1
    
  }
  
  # remaining elements :
  if(length(x) > 0) {
    foo = sample(x, size = length(x), replace = FALSE)    # last sample
    vals[[i]] = foo                                       # add last element to the list
    
  }
  
  vals
  
}


getProteins <- function(SPARCLElabels, familyID = legumesIds){
  
  my_values = c()
  
  for(n in seq(SPARCLElabels)) {
    my_protIds <- getProtlinks(SPARCLElabels[n])
  
    if(length(my_protIds) < 301) {
      my_values <- c(my_values, extract_proteins(my_protIds, familyID))
      
    } else {
      protIds_subset <-  subsetIds(my_protIds, 300)
      
      for(i in seq_along(protIds_subset)) {
        my_targets = protIds_subset[[i]]
        my_values = c(my_values, extract_proteins(my_targets,familyID ))
      
      }
    }
  }
  
  my_values = unique(my_values)
  my_values 
  }
 


extract_spp <- function(target) {
  
  spp = c()
  
  if(length(target) < 300   ) {
    
    upload <- entrez_post(db="protein", id=target) #create a web_history object
    prot_summ = entrez_summary(db="protein", web_history=upload)
    prot_title = as.character((extract_from_esummary(prot_summ, c("title"))))
    spp = prot_title
    
  } else {
    
    target = subsetIds(target, 300)
    for(i in seq(length(target))) {
      upload <- entrez_post(db="protein", id=target[[i]]) #create a web_history object 
      prot_summ = entrez_summary(db="protein", web_history=upload)
      prot_title = as.character((extract_from_esummary(prot_summ, c("title"))))
      spp = c(spp, prot_title)
    }
  }
  
  
  spp
  
  
}




get_spp <- function(description) {
  
  # extract the scientific name from a sequence description 
  # example: "PREDICTED: auxin response factor 19-like isoform X1 [Glycine max]"
  
  spp <- str_sub(description, 
                 start = str_locate(description, "\\[")[1]+1,
                 end = str_locate(description, "\\]")[2]-1)
  spp
}


extract_XP_from_spp <- function(target, myspp) {
  # ''' target, vector/list object with protein ids 
  # ''' spp, spp target to extract its XP ids. Official NCBI Genus / Genus species nomenclature. 
  
  xp = c()
  prot_test = c()
  
  if(length(target) < 300   ) {
    
    upload <- entrez_post(db="protein", id=target) #create a web_history object
    prot_summ = entrez_summary(db="protein", web_history=upload)
    prot_test = as.character((extract_from_esummary(prot_summ, c("caption","title"))))
    
  } else {
    target = subsetIds(target, 300)
    for(i in seq(length(target))) {
      upload <- entrez_post(db="protein", id=target[[i]]) #create a web_history object
      prot_summ = entrez_summary(db="protein", web_history=upload)
      prot_test = c(prot_test, as.character((extract_from_esummary(prot_summ, c("caption","title")))))
      
    } }
  
  # Build dataframe
  prot_test_df = data.frame(matrix(unlist(prot_test), nrow = length(prot_test)/2, byrow = T), 
                            stringsAsFactors = F) # /2 bc we have 2 columns: caption,title
  
  # Extract ID based on selected species 
  idx = which(str_detect(prot_test_df$X2, myspp))
  xp = prot_test_df[idx,1]
  
  xp
  
  
}

## Usage
#targets <- "1012032540" "1117497421" "1012113555"
#extract_XP_from_spp(targets, "Cicer arietinum")

